<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.foshanplus.mediaperformance.mapper.ArticleMapper" >

	<resultMap id="BaseResultMap" type="com.foshanplus.mediaperformance.bean.Article" >
		<result column="id" property="id"/>
		<result column="type" property="type"/>
		<result column="newsType" property="newsType"/>
		<result column="newsSourceId" property="newsSourceId"/>
		<result column="newsTransferId" property="newsTransferId"/>
		<result column="paperPublishTime" property="paperPublishTime"/>
		<result column="appPublishTime" property="appPublishTime"/>
		<result column="pageName" property="pageName"/>
		<result column="category" property="category"/>
		<result column="paperTitle" property="paperTitle"/>
		<result column="appTitle" property="appTitle"/>
		<result column="author" property="author"/>
		<result column="editor" property="editor"/>
		<result column="wordCount" property="wordCount"/>
		<result column="url" property="url"/>
		<result column="remark" property="remark"/>
		<result column="scoreId" property="scoreId"/>
		<result column="score" property="score"/>
		<result column="clickCount" property="clickCount"/>
		<result column="createUser" property="createUser"/>
		<result column="createTime" property="createTime"/>
		<result column="updateUser" property="updateUser"/>
		<result column="updateTime" property="updateTime"/>
	</resultMap>
	
	<sql id="Article_List" >
		id, type, newsType, newsSourceId, newsTransferId, paperPublishTime, appPublishTime, pageName, category, 
		paperTitle, appTitle, author, editor, wordCount, url, createUser, createTime, updateUser, updateTime
	</sql>
	
	<insert id="add" parameterType="com.foshanplus.mediaperformance.bean.Article">
		INSERT INTO t_article(
			  type, newsType, newsSourceId, newsTransferId
			, paperPublishTime, appPublishTime, pageName, category
			, paperTitle, appTitle, author, editor, wordCount, url
			, createUser, createTime, updateUser, updateTime
		)
		values(
			  #{type}, #{newsType}, #{newsSourceId}, #{newsTransferId}
			, #{paperPublishTime}, #{appPublishTime}, #{pageName}, #{category}
			, #{paperTitle}, #{appTitle}, #{author}, #{editor}, #{wordCount}, #{url}
			, #{createUser}, #{createTime}, #{updateUser}, #{updateTime}
		)
	</insert>
	
	<delete id="delete" parameterType="java.lang.Long">
		DELETE FROM t_article WHERE id = #{id}
	</delete>
	
	<select id="findAll" resultMap="BaseResultMap">
		SELECT 
			a.id
			,a.type
			,a.newsType
			,a.newsSourceId
			,a.newsTransferId
			,a.paperPublishTime
			,a.appPublishTime
			,a.pageName
			,a.category
			,a.paperTitle
			,a.appTitle
			,a.author
			,a.editor
			,a.wordCount
			,a.url
			,asr.scoreId
			,asr.remark
			,CASE score.id WHEN '手动打分' THEN NULL ELSE CONCAT(score.score, '') END AS score
			,acc.clickCount
		FROM t_article a
		LEFT JOIN t_article_score_record asr ON asr.newsTransferId = a.newsTransferId
		LEFT JOIN t_article_score score ON score.id = asr.scoreId
		LEFT JOIN t_article_click_count acc ON acc.title = a.appTitle
		<where>
		<if test="type != null">
			AND a.type = #{type}
		</if>
		<if test="paperStartTime != null and paperStartTime != '' and paperEndTime != null and paperEndTime != ''">
			AND a.paperPublishTime between #{paperStartTime} AND #{paperEndTime}
		</if>
		<if test="appStartTime != null and appStartTime != '' and appEndTime != null and appEndTime != ''">
			AND a.appPublishTime between #{appStartTime} AND #{appEndTime}
		</if>
		<if test="paperTitle != null and paperTitle != ''">
			AND a.paperTitle like CONCAT('%', '${paperTitle}', '%')
		</if>
		<if test="appTitle != null and appTitle != ''">
			AND a.appTitle like CONCAT('%', '${appTitle}', '%')
		</if>
		<if test="author != null and author != ''">
			AND a.author like CONCAT('%', '${author}', '%')
		</if>
		<if test="isScore != null and isScore != '' ">
		<choose>
			<when test="isScore == 1">
				AND NOT ISNULL(asr.id)
			</when>
			<otherwise>
				AND ISNULL(asr.id)
			</otherwise>
		</choose>
		</if>
		<if test="scoreId != null and scoreId != '' ">
			AND asr.scoreId = #{scoreId}
		</if>
		</where>
	</select>
	
	<select id="findById" resultMap="BaseResultMap">
		SELECT 
			a.id
			,a.type
			,a.newsType
			,a.newsSourceId
			,a.newsTransferId
			,a.paperPublishTime
			,a.appPublishTime
			,a.pageName
			,a.category
			,a.paperTitle
			,a.appTitle
			,a.author
			,a.editor
			,a.wordCount
			,a.url
			,asr.scoreId
			,asr.remark
			,CASE score.id WHEN '手动打分' THEN NULL ELSE CONCAT(score.score, '') END AS score
			,acc.clickCount
		FROM t_article a 
		LEFT JOIN t_article_score_record asr ON asr.newsTransferId = a.newsTransferId
		LEFT JOIN t_article_score score ON score.id = asr.scoreId
		LEFT JOIN t_article_click_count acc ON acc.title = a.appTitle
		where a.id = #{id}
	</select>
	
	<update id="update" parameterType="com.foshanplus.mediaperformance.bean.Article">
		update t_article
		<set>
			<if test="type != null">
				type = #{type, jdbcType = TINYINT},
			</if>
			<if test="newsType != null">
				newsType = #{newsType, jdbcType = TINYINT},
			</if>
			<if test="paperPublishTime != null">
				paperPublishTime = #{paperPublishTime, jdbcType = DATE},
			</if>
			<if test="appPublishTime != null">
				appPublishTime = #{appPublishTime, jdbcType = TIMESTAMP},
			</if>
			<if test="pageName != null">
				pageName = #{pageName, jdbcType = VARCHAR},
			</if>
			<if test="category != null">
				category = #{category, jdbcType = VARCHAR},
			</if>
			<if test="paperTitle != null">
				paperTitle = #{paperTitle, jdbcType = VARCHAR},
			</if>
			<if test="appTitle != null">
				appTitle = #{appTitle, jdbcType = VARCHAR},
			</if>
			<if test="author != null">
				author = #{author, jdbcType = VARCHAR},
			</if>
			<if test="editor != null">
				editor = #{editor, jdbcType = VARCHAR},
			</if>
			<if test="wordCount != null">
				wordCount = #{wordCount, jdbcType = INTEGER},
			</if>
			<if test="url != null">
				url = #{url, jdbcType = VARCHAR},
			</if>
			<if test="updateUser != null">
				updateUser = #{updateUser, jdbcType = VARCHAR},
			</if>
			<if test="updateTime != null">
				updateTime = #{updateTime, jdbcType = TIMESTAMP},
			</if>
		</set>
		where id = #{id}
	</update>
	
</mapper>